<!DOCTYPE html>
<html lang="he">

<head>
    <meta charset="utf-8" />
    <title>משק יעקבס</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="Responsive bootstrap 4 admin template" name="description" />
    <meta content="Coderthemes" name="author" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- App favicon -->
    <link rel="shortcut icon" href="assets/images/LOGO.ico">

    <!-- Plugins css-->
    <link href="assets/libs/sweetalert2/sweetalert2.min.css" rel="stylesheet" type="text/css" />
    <script src="../fullcalendar/Calendar.js"></script>
    <link href="../fullcalendar/Calendar.css" rel="stylesheet" />

    <script src="../Scripts/ajaxCalls.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
            crossorigin="anonymous">
    </script>

    <!-- App css -->
    <link href="assets/css/bootstrap.min.css" rel="stylesheet" type="text/css" id="bootstrap-stylesheet" />
    <link href="assets/css/icons.min.css" rel="stylesheet" type="text/css" />
    <link href="assets/css/app.min.css" rel="stylesheet" type="text/css" id="app-stylesheet" />
    <link href="../CSS/main.css" rel="stylesheet" />

    <!--POP AP-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <link href="../fullcalendar/popup.css" rel="stylesheet" />
    
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/js/bootstrap.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.7.0/moment.min.js'></script>
    <!--<script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/2.0.3/fullcalendar.min.js'></script>-->



    <style>

        #eventDiv{
            text-align:center;
        }
        .fc .fc-non-business {
            background: rgba(215, 215, 215, 0.3);
            background: var(--fc-non-business-color, rgba(215, 215, 215, 0.3));
        }

        .fc-daygrid-dot-event .fc-event-title {
            flex-grow: 1;
            flex-shrink: 1;
            min-width: 0; /* important for allowing to shrink all the way */
            overflow: hidden;
            font-size: 13px;
            padding:0px;
        }
        .fc-event {
            border-radius: 2px;
            border: none;
            cursor: move;
            font-size: .8125rem;
            margin: 1px 1px;
            padding: 0px;
            text-align: center;
        }

        .fc-v-event .fc-event-title {
        top: 0;
        bottom: 0;
        max-height: 100%;
        overflow: hidden;
        font-size: 7px;
        }

        .fc .fc-list-event-title a {
            color: inherit;
            text-decoration: none;
            font-size: 15px;
        }
        #BTN {
            width: 200px;
            background-color: #FFE587;
            color: black;
            border: hidden;
            padding: 5px;
            margin-top: 20px;
            font-size: 18px;
            line-height: 1.3333333;
            border-radius: 6px;
        }
        .fc-event {
            background-color: #fff;
            border:0
        }
        .deleteBtn{
            background-color: #FFE587;
            border: hidden;
            padding: 5px;
            margin-top: 20px
        }
        img {
            width: 60px;
            height: 50px;
        }
        #deleteBtn {
            width: 20px;
            height: 25px;
        }
        #idorder {
            background-color: #ffe587;
            padding: 5px;
        }
        select {
            text-align:center
        }
        label{
            padding:3px;
        }
    </style>
    <script>

        $(document).ready(function () {

            funcInit();

            $("#BTN").click(funcEmploye);
        });

        function funcInit() {
            eventsArr = [];//מערך של הזמנות 
            detailsOrder = [];//פרטי כל הזמנה
            productArr = [];//מערך של מוצרים 
            collectors = [];//כל המלקטים
            drivers = [];//כל הנהגים 

            ajaxCall("GET", "../api/Orders", "", getOrderSCB, error);
        }

        function getOrderSCB(list) {
            count = 0;

            for (obj in list) {

                dd = '';
                mm = '';
                yyyy = '';

                date = list[obj]["DateArrival"].split('.');

                if (date[0].length == 1)
                    dd = "0" + date[0];
                else
                    dd = date[0];
                if (date[1].length == 1)
                    mm = "0" + date[1];
                else
                    mm = date[1];

                yyyy = date[2];

                startDate = yyyy + "-" + mm + "-" + dd + "T" + list[obj]["OpenHour"] + ":00";
                endDate = yyyy + "-" + mm + "-" + dd + "T" + list[obj]["OpenHour"] + ":00";

                color = '#f9abab';

                if (list[obj]["DistributaionArea"] == 'צפון')
                    color = '#bce3fe';
                else if (list[obj]["DistributaionArea"] == 'דרום')
                    color = '#9cf3cd';
                else if ((list[obj]["DistributaionArea"] == 'ירושלים'))
                    color = '#f5e8aa';

                eventsArr[count] = {
                    id: list[obj]["OrderNum"],
                    title: list[obj]["CompanyName"],
                    start: startDate,
                    end: endDate,
                    color: color
                }

                preparationDate = '';
                if (list[obj]["PreprationDate"] != '')
                    preparationDate = list[obj]["PreprationDate"]

                detailsOrder[count] = {
                    idOrder: list[obj]["OrderNum"],
                    idCompany: list[obj]["Companynum"],
                    nameCompany: list[obj]["CompanyName"],
                    startDate: list[obj]["StartDate"],
                    dateArrive: list[obj]["DateArrival"],
                    openArrive: list[obj]["OpenHour"],
                    closeArrive: '',
                    nameContact: '',
                    phoneContact: '',
                    productOrder:[],
                    statusOrder: list[obj]["Status"],
                    collercotrArr:[],
                    preparationDate: preparationDate,
                    driverArr:[]
                }
                count++;


            }

            ajaxCall("GET", "../api/Companies", "", getCompanySCB, error);


            render();
        }

        function getCompanySCB(list) {

            for (obj in list) {
                for (item in detailsOrder) {
                    if (list[obj]["CompanyNum"] == detailsOrder[item]["idCompany"]) {
                        detailsOrder[item]["closeArrive"] = list[obj]["CloseHour"]
                        detailsOrder[item]["nameContact"] = list[obj]["NameContact"]
                        detailsOrder[item]["phoneContact"] = list[obj]["PhoneContact"]
                    }
                }
            }
            ajaxCall("GET", "../api/Employes", "", getEmployeSCB, error);
        }

        function getEmployeSCB(list) {


            for (obj in list) {
                for (item in detailsOrder) {
                    if (list[obj]["OrderNum"] == detailsOrder[item]["idOrder"]) {
                        if (list[obj]["EmployeNum"] != 0)
                            detailsOrder[item]["collercotrArr"][0] = list[obj]["EmployeNum"];
                        if (list[obj]["DriverNum"] !=0)
                            detailsOrder[item]["driverArr"][0] = list[obj]["DriverNum"]
                    }
                }
            }

            x = 0;

            ajaxCall("DELETE", "../api/Employes/" + x, "", getEmploye, error);

        }

        function getEmploye(list) {

            x = 0;
            y = 0;

            for (obj in list) {
                if (list[obj]["Role"] == "מלקט") {
                    collectors[x] = list[obj];
                    x++;
                }
                else if (list[obj]["Role"] == "נהג") {
                    drivers[y] = list[obj];
                    y++;
                }
            }

            for (x in detailsOrder) {

                if (detailsOrder[x]["collercotrArr"] == 0) {
                    detailsOrder[x]["collercotrArr"] = collectors;
                }

                if (detailsOrder[x]["driverArr"] == 0) {
                    detailsOrder[x]["driverArr"] = drivers;
                }

            }

            console.log(detailsOrder)

            ajaxCall("GET", "../api/Product", "", getOrderProductSCB, error);
        }
        function getOrderProductSCB(list) {
 
            next = 0;
            y = 0;
            for (let i = 0; i < list.length; i=y+1) {
                x = list[i]["OrderNum"];
                array = [];
                count = 0;
                for (obj in list) {
                    if (x == list[obj]["OrderNum"]) {
                        array[count] = list[obj];
                        count++
                        y = parseInt(obj);
                    }


                }
                productArr[next] = array;
                next++;
            }


            for (ans in productArr) {
                for (item in detailsOrder) {
                    if (productArr[ans][0]["OrderNum"] == detailsOrder[item]["idOrder"]) {
                        detailsOrder[item]["productOrder"] = productArr[ans]
                    }
                }
            }

        }


        function render() {


            var calendarEl = document.getElementById('calendar');

            var calendar = new FullCalendar.Calendar(calendarEl, {
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                initialDate: new Date(),
                navLinks: true, // can click day/week names to navigate views
                businessHours: {
                    startTime: '06:00',
                    endTime: '17:00',
                    daysOfWeek: [0, 1, 2, 3, 4]
                },
                locale: 'he',
                direction: 'rtl',
                buttonText: {
                    today: 'היום',
                    day: 'יום',
                    week: 'שבוע',
                    month: 'חודש',
                },
                hiddenDays: [5, 6],
                displayEventTime: false,
                editable: false,
                events: eventsArr,
                eventClick: function (info) {
                    var modal = $("#editEvent");
                    modal.modal();
                    
                    renderOrder(info.event.id);
                },

            });
            calendar.render();
        };


        function renderOrder(id) {

            IdOrder = id;
            answer = '';

            for (obj in detailsOrder) {

                if (detailsOrder[obj]["idOrder"] == id) {

                    if (detailsOrder[obj]["statusOrder"] == 1) {
                        answer = "פתוח"
                    }
                    if (detailsOrder[obj]["statusOrder"] == 0) {
                        answer = "ההזמנה לוקטה"
                    }

                    str = '<div>';

                    str += "<h2 id='idorder'>מספר הזמנה : " + detailsOrder[obj]["idOrder"] + "</h2>";
                    str += "<br/><br/>";
                    str += "<p>שם החברה : " + detailsOrder[obj]["nameCompany"] + "<p>";
                    str += "<p> תאריך פתיחת ההזמנה : " + detailsOrder[obj]["startDate"] + "</p>";
                    str += "<p>תאריך הגעה : " + detailsOrder[obj]["dateArrive"].replace('.', "/").replace('.', "/") + "</p>";
                    str += "<p> שעות הגעה : " + detailsOrder[obj]["closeArrive"] + " - " + detailsOrder[obj]["openArrive"] + "</p>";
                    str += "<p> איש קשר : " + detailsOrder[obj]["nameContact"] + "&nbsp&nbsp&nbspטלפון איש קשר : " + detailsOrder[obj]["phoneContact"] + "</p>";

                    str += "<p> סטטוס הזמנה - " + answer + "</p>";

                    str += "<select id='product' class='form - control'>";
                    str += "<option>מוצרי ההזמנה</option>";
                    detailsOrder[obj]["productOrder"].forEach(function (value) {
                        str += "<option>";
                        str += "<p>" + value["Barcod"] + "  - " + value["NameProduct"] + "</p>";
                        str += "</option>";
                    })
                    str += "</select>";
                    str += "<br/><br/>";


                    if (detailsOrder[obj]["preparationDate"] != null) {
                        str += "<p id='dateCollect'> תאריך ליקוט ההזמנה : " + detailsOrder[obj]["preparationDate"] + "</p>";
                    }
                    else {
                        str += "<label for='dateCollect'> הכנס תאריך הכנת הזמנה    </label>";
                        str += "<input type='date' id='dateCollect' >";

                    }

                    str += "<br/><br/>";

                    if (detailsOrder[obj]["collercotrArr"].length ==1) {
                        str += "<p> מלקט ההזמנה : " + detailsOrder[obj]["collercotrArr"] + "</p>";
                    }
                    else {
                        str += "<select id='collect' class='form - control' >";
                        str += "<option>בחר מלקט להזמנה</option>";
                        detailsOrder[obj]["collercotrArr"].forEach(function (value) {
                            str += "<option>";
                            str += value["EmployeNum"] + " - " + value["Name"];
                            str += "</option>";
                        })
                        str += "</select>";
                    }
                    str += "<br/><br/>";


                    if (detailsOrder[obj]["driverArr"].length == 1) {
                        str += "<p> נהג ההזמנה : " + detailsOrder[obj]["driverArr"] + "</p>";
                    }
                    else {
                        str += "<select id='driver' class='form - control' >";
                        str += "<option>בחר נהג להזמנה</option>";
                        detailsOrder[obj]["driverArr"].forEach(function (value) {
                            str += "<option>";
                            str += value["EmployeNum"] + " - " + value["Name"] + "  אזור חלוקה - " + value["DistributaionArea"];
                            str += "</option>";
                        })
                        str += "</select>";
                    }
                    str += "<br/><br/>";

                 
                    str += '</div>';

                    document.getElementById("eventDiv").innerHTML = str;


                }
            }
        }

        function funcEmploye() {
            console.log(IdOrder)
            collect = document.getElementById("collect").value.split('-');
            driver = document.getElementById("driver").value.split(' ');

            idcollect = collect[0];
            iddriver = driver[0];

            if (idcollect == 'בחר' || $("#dateCollect").val() == null || iddriver == 'בחר' ) {
                swal("יש למלא תאריך ליקוט , עובד להכנת ההזמנה ונהג להוצאת ההזמנה ")
            }
            else {

                date = $("#dateCollect").val();
                date = date.split('-');
                date = date[2] + "/" + date[1] + "/" + date[0];
                console.log(date);
                EmployeOrder = {
                    OrderNum: IdOrder,
                    EmployeeNum: idcollect,
                    PreprationDate: date,
                    DriverNum: iddriver,
                }
                ajaxCall("PUT", "../api/Orders", JSON.stringify(EmployeOrder), succsess, error);
            }
          
        }

        function succsess() {
            console.log("wow");
            funcInit();
        }

        function error(err) {
            swal("Error: " + err);
        }

    </script>

</head>
<body>
    <!-- Begin page -->
    <div id="wrapper">

        <!-- Topbar Start -->
        <div class="navbar-custom">
            <h3 style="margin-top:10px">
                &nbsp; &nbsp; משק יעקבס
                <img src="../img/LOGO.png" />
            </h3>
            <!-- LOGO -->
        </div>
        <!-- end Topbar -->
        <!-- ========== Left Sidebar Start ========== -->
        <div class="left-side-menu">
            <div class="slimscroll-menu">
                <!--- Sidemenu -->
                <div id="sidebar-menu">
                    <div class="user-box">
                        <div class="float-left">
                            <a href="login.html" class="waves-effect">
                                <i class="mdi mdi-account" id="LOgin"></i>
                            </a>
                        </div>
                    </div>

                    <ul class="metismenu" id="side-menu">
                        <li>
                            <a href="main.html" class="waves-effect">
                                <i class="mdi mdi-calendar"></i>
                                <span> לוח שנה </span>
                            </a>
                        </li>
                        <li>
                            <a href="employe.html" class="waves-effect">
                                <i class=" mdi mdi-account"></i>
                                <span> עובדים </span>
                            </a>
                        </li>
                        <li>
                            <a href="newOrder.html" class="waves-effect">
                                <i class=" mdi mdi-folder-plus"></i>
                                <span> הזמנה חדשה </span>
                            </a>
                        </li>
                        <li>
                            <a href="sendOrder.html" class="waves-effect">
                                <i class=" mdi mdi-calendar"></i>
                                <span> הפצת הזמנות </span>
                            </a>
                        </li>
                    </ul>
                </div>
                <!-- End Sidebar -->
                <div class="clearfix"></div>
            </div>
            <!-- Sidebar -left -->
        </div>
        <!-- Left Sidebar End -->
        <!-- ============================================================== -->
        <!-- Start Page Content here -->
        <!-- ============================================================== -->
        <!--calender-->
        <div class="content-page">
            <div class="content">
                <!-- Start Content-->
                <div class="container-fluid">
                    <!-- start page title -->
                    <div class="row">
                        <div class="col-12">
                            <div class="page-title-box">
                            </div>
                        </div>
                    </div>
                    <!-- end page title -->
                    <div class="row">
                        <div class="col-lg-12">

                            <div class="card-box">
                                <div class="row">
                                    <div class="col-lg-10">

                                        <div id='calendar'></div>
                                    </div>
                                    <div class="col-lg-2" style="margin-top:20%">
                                        <p style="background-color: #bce3fe; border-radius: 25px; text-align: center ">צפון</p>
                                        <p style="background-color: #9cf3cd; border-radius: 25px; text-align: center ">דרום</p>
                                        <p style="background-color: #f5e8aa; border-radius: 25px; text-align: center ">מרכז</p>
                                        <p style="background-color: #f9abab; border-radius: 25px; text-align:center">ירושלים</p>
                                    </div>
                                    <!-- end row -->
                                </div>
                            </div>
                            <!-- end col-12 -->
                        </div>
                        <!-- end row -->

                    </div>
                    <!-- end container-fluid -->

                </div>
                <!-- end content -->
                <!-- Edit Modal -->
                <div class="modal fade" id="editEvent">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <!-- Modal Header -->
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                            </div>
                            <!-- Modal body -->
                            <div class="modal-body">
                               <div id="eventDiv"></div>
                            </div>
                            <!-- Modal footer -->
                            <div class="modal-footer">
                                <button class='deleteBtn btn btn-info' > <img id="deleteBtn" src='../img/Delete.png' />  </button> 
                                <button type="button" id="BTN" class="btn btn-danger" data-dismiss="modal">שמור</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>

            <!-- ============================================================== -->
            <!-- End Page content -->
            <!-- ============================================================== -->

    </div>

    <!-- Vendor js -->
    <script src="assets/js/vendor.min.js"></script>

    <!-- App js -->
    <script src="assets/js/app.min.js"></script>

</body>
</html>